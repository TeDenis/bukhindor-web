# Active Context

## Текущий фокус работы
Полная интеграция Flutter Web c API и доставка метаданных сборки (дата, коммит, ветка) на страницу `'/version'`. Устранение ошибок манифеста/мета-тегов и CORS через nginx reverse-proxy `/api`.

## Последние изменения
- ✅ Проброс метаданных сборки в `AppConstants` через `String.fromEnvironment`
- ✅ Сборка с `--dart-define` в `Dockerfile` и `scripts/build-and-docker.sh`
- ✅ Nginx reverse-proxy `/api` -> `https://api.go-dev.kz` для обхода CORS
- ✅ Обновлён `index.html`: добавлен `mobile-web-app-capable`, CSP расширен
- ✅ `ApiConfig` использует `AppConstants.apiBaseUrl` и таймаут из констант
- ✅ Кэширование статических `json` в nginx
- ✅ **ПОЛНАЯ ИНТЕГРАЦИЯ С API**: Заменена mock-аутентификация на реальную систему
- ✅ **Добавлены HTTP зависимости**: dio, dio_smart_retry, shared_preferences
- ✅ **Создана конфигурация API**: ApiConfig с базовым URL и эндпоинтами
- ✅ **Созданы модели данных**: Полный набор API моделей согласно OpenAPI схеме
- ✅ **Реализован токен менеджер**: TokenManager для работы с JWT токенами в localStorage
- ✅ **Создан API сервис**: ApiService с Dio клиентом и interceptors
- ✅ **Автоматическое обновление токенов**: При получении 401 ошибки
- ✅ **Обновлен репозиторий**: AuthRepositoryImpl для работы с реальным API
- ✅ **Улучшен BLoC**: Добавлены отдельные состояния загрузки и детальная обработка ошибок
- ✅ **Клиентская валидация**: ValidationUtils согласно API схеме
- ✅ **Обновлены формы**: Использование новой валидации и состояний загрузки
- ✅ **Детальное отображение ошибок**: Показ технических деталей в SnackBar
- ✅ **Проверка токенов при запуске**: Автоматическая проверка при старте приложения
- ✅ **ИСПРАВЛЕНА ПРОБЛЕМА DOCKER**: Добавлена генерация кода в Dockerfile
- ✅ **Обновлен Dockerfile**: Добавлен шаг `dart run build_runner build --delete-conflicting-outputs`
- ✅ **Создан скрипт генерации**: `scripts/generate_code.sh` для локальной разработки
- ✅ **Обновлен .gitignore**: Сгенерированные файлы теперь включены в репозиторий
- ✅ **Обновлен README**: Добавлены инструкции по генерации кода
- ✅ **ОБНОВЛЕНЫ ЗАВИСИМОСТИ**: Исправлены предупреждения о версиях SDK
- ✅ **Обновлен pubspec.yaml**: Версии пакетов совместимы с Dart 3.10.0
- ✅ **ОБНОВЛЕНЫ ДО НОВЫХ ВЕРСИЙ**: flutter_bloc ^9.1.1, freezed_annotation ^3.1.0, go_router ^16.1.0
- ✅ **ИСПРАВЛЕНА ВЕРСИЯ SDK**: Обновлена до '>=3.8.0 <4.0.0' для совместимости
- ✅ **ОБНОВЛЕНЫ DEV ЗАВИСИМОСТИ**: build_runner ^2.6.0, freezed ^3.2.0, json_serializable ^6.10.0
- ⚠️ **ПРОБЛЕМА С DOCKER**: Сгенерированные файлы не попадают в финальную сборку после flutter clean

## Текущее состояние
- **Полная интеграция с API** `https://api.go-dev.kz`:
  - **HTTP клиент**: Dio с retry логикой и interceptors
  - **JWT токены**: Автоматическое сохранение и обновление
  - **Модели данных**: Соответствуют OpenAPI схеме
  - **Валидация**: Клиентская валидация согласно API требованиям
  - **Обработка ошибок**: Детальное отображение ошибок API
  - **Состояния загрузки**: Отдельные состояния для входа, регистрации и сброса пароля

- Система версионирования включает:
  - **Константы версии** в `lib/core/constants/app_constants.dart`
  - **Страницу версии** `/version` с полной информацией
  - **Виджеты** для отображения информации о версии, заметок о релизе и информации о разработке
  - **Инструкцию** по версионированию в `VERSIONING.md`
  - **Автоматический скрипт** `scripts/bump_version.sh` для обновления версии
  - **Ссылки** на страницу версии в главной странице и меню пользователя

- Секретные функции доступа:
  - **4 клика на логотип совы** открывают диалог для перехода на страницу версии
  - **Таймаут 3 секунды** между кликами для сброса счетчика
  - **Анимация при клике** с эффектом bounce
  - **Кнопка возврата** к авторизации на странице версии
  - **Диалог подтверждения** перед открытием страницы версии

- **Docker оптимизация**:
  - **Улучшенный Dockerfile** с принудительной очисткой и пересборкой
  - **Генерация кода в Docker**: Добавлен шаг `dart run build_runner build --delete-conflicting-outputs`
  - **Файл .dockerignore** для исключения ненужных файлов
  - **Обновленный docker-compose.yml** с healthcheck
  - **Скрипт docker-rebuild.sh** для решения проблем с кэшированием
  - **Скрипт generate_code.sh** для локальной генерации кода
  - **Документация** по использованию в scripts/README.md

## Следующие шаги
- Тест prod-деплоя c `API_BASE_URL` пустым (используется `/api` nginx)
- Проверка страницы `'/version'` на показ даты/коммита/ветки
- Тестирование интеграции с API
- Проверка всех сценариев аутентификации
- Тестирование автоматического обновления токенов
- Проверка обработки сетевых ошибок
- Тестирование валидации форм
- Оптимизация производительности
- Возможные улучшения UX

## Активные решения
- **Интеграция с реальным API**: Замена mock-данных на API вызовы
- **JWT токены**: Автоматическое управление access и refresh токенами
- **Retry логика**: Автоматические повторы при сетевых ошибках
- **Interceptor паттерн**: Автоматическое добавление токенов к запросам
- **Клиентская валидация**: Согласно API схеме с детальными сообщениями
- **Отдельные состояния загрузки**: Для каждой операции аутентификации
- **Детальная обработка ошибок**: Показ технических деталей пользователю
- **Автоматическая проверка токенов**: При запуске приложения
- **Безопасное хранение**: Токены в localStorage через SharedPreferences
- **Генерация кода в Docker**: Автоматическая генерация Freezed и JSON сериализации в контейнере
- **Включение сгенерированных файлов**: В репозиторий для стабильности Docker сборки
- **Совместимость версий**: Все зависимости обновлены для совместимости с Dart 3.10.0